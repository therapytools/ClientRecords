<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered Client Data Organizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #c7c7c7;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        .panel {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            display: flex;
            flex-direction: column;
            height: calc(100vh - 8rem);
            min-width: 150px; /* Prevent panels from becoming too small */
        }
        .list-item {
            cursor: pointer;
            transition: background-color 0.2s;
            border-right: 4px solid transparent;
        }
        .list-item.selected {
            background-color: #e0f2fe;
            border-color: #38bdf8;
            font-weight: 600;
        }
        .list-item:hover {
            background-color: #f0f9ff;
        }
        textarea {
            resize: none;
        }
        .btn {
            transition: background-color 0.2s, transform 0.1s;
        }
        .btn:hover {
            transform: translateY(-1px);
        }
         .btn:disabled {
            background-color: #d1d5db;
            cursor: not-allowed;
            transform: none;
        }
        .btn-primary {
            background-color: #38bdf8;
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #0ea5e9;
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #374151;
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        .btn-danger {
             background-color: #fee2e2;
             color: #ef4444;
        }
        .btn-danger:hover {
            background-color: #fecaca;
            color: #dc2626;
        }
        .resizer {
            background: #e5e7eb;
            cursor: col-resize;
            width: 6px;
            z-index: 10;
        }
        .resizer-y {
            background: #e5e7eb;
            cursor: row-resize;
            height: 6px;
            z-index: 10;
        }
    </style>
</head>
<body class="p-4 md:p-6 lg:p-8">
    <div id="app" class="flex flex-col h-full">
        <!-- Header -->
        <header class="flex flex-wrap items-center justify-between mb-6 pb-4 border-b">
            <h1 class="text-3xl font-bold text-gray-800">Client Data Organizer</h1>
            <div class="flex items-center space-x-4 mt-4 sm:mt-0">
                 <div class="flex items-center space-x-2">
                    <input type="password" id="apiKeyInput" class="border border-gray-300 rounded-md px-3 py-2 text-sm w-48 focus:outline-none focus:ring-2 focus:ring-sky-400" placeholder="Gemini API Key...">
                    <button id="setApiKeyBtn" class="btn btn-secondary font-semibold py-2 px-4 rounded-lg shadow-sm text-sm">Set Key</button>
                </div>
                <button id="eraseAllBtn" class="btn btn-danger font-semibold py-2 px-4 rounded-lg shadow-sm">Erase All Data</button>
                <button id="saveBtn" class="btn btn-primary font-semibold py-2 px-4 rounded-lg shadow-sm">Export</button>
                <button id="loadBtn" class="btn btn-secondary font-semibold py-2 px-4 rounded-lg shadow-sm">Import</button>
                <div id="autoSaveIndicator" class="text-sm text-gray-500 ml-4 hidden">
                    <span id="saveStatus"></span>
                </div>
            </div>
        </header>

        <!-- Main Content Grid -->
        <main class="flex flex-col md:flex-row flex-grow gap-6" id="mainGrid">
            <!-- Panel 1: Clients -->
            <div class="panel flex flex-col" id="panelClients" style="flex-basis: 16.66%;">
                <h2 class="text-xl font-semibold text-gray-700 p-4 border-b">Clients</h2>
                <div id="clientList" class="flex-grow overflow-y-auto"></div>
                <div class="p-4 border-t">
                    <input type="text" id="newClientInput" class="w-full border border-gray-300 rounded-md px-3 py-2 mb-2 focus:outline-none focus:ring-2 focus:ring-sky-400" placeholder="New client name...">
                    <button id="addClientBtn" class="w-full btn btn-primary font-semibold py-2 rounded-lg">Add Client</button>
                </div>
                <div class="p-4 border-t">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-semibold text-gray-600">Recently Deleted</h3>
                        <button id="clearDeletedClientsBtn" class="btn btn-danger text-xs px-2 py-1 rounded-md">Clear</button>
                    </div>
                    <div id="deletedClientsList" class="text-sm text-gray-500 max-h-24 overflow-y-auto"></div>
                </div>
                <div class="p-4 border-t">
                    <h3 class="font-semibold text-gray-600 mb-2">Archived Clients</h3>
                    <div id="archivedClientsList" class="text-sm text-gray-500 max-h-24 overflow-y-auto"></div>
                </div>
            </div>

            <div class="resizer" id="resizer1"></div>

            <!-- Panel 2: Appointments -->
            <div class="panel flex flex-col" id="panelAppointments" style="flex-basis: 16.66%;">
                <h2 class="text-xl font-semibold text-gray-700 p-4 border-b">Appointments</h2>
                <div id="appointmentList" class="flex-grow overflow-y-auto"></div>
                <div class="p-4 border-t">
                    <label for="appointmentDate" class="font-semibold text-gray-600 text-sm mb-1">Appointment Date</label>
                    <input type="date" id="appointmentDate" class="w-full border border-gray-300 rounded-md px-3 py-2 mb-2 focus:outline-none focus:ring-2 focus:ring-sky-400">
                    <button id="addAppointmentBtn" class="w-full btn btn-primary font-semibold py-2 rounded-lg mb-4" disabled>Add Appointment</button>
                    <div class="flex justify-between items-center mb-2 mt-4">
                        <h3 class="font-semibold text-gray-600">Recently Deleted</h3>
                        <button id="clearDeletedAppointmentsBtn" class="btn btn-danger text-xs px-2 py-1 rounded-md">Clear</button>
                    </div>
                    <div id="deletedAppointmentsList" class="text-sm text-gray-500 max-h-24 overflow-y-auto"></div>
                </div>
            </div>

            <div class="resizer" id="resizer2"></div>

            <!-- Panel 3: Session Information & Notes -->
            <div class="panel flex flex-col" id="panelSession" style="flex-basis: 33.33%;">
                <div class="flex flex-col h-full">
                    <div id="sessionInfoWrapper" class="flex flex-col" style="flex-basis: 50%;">
                         <div class="flex justify-between items-center p-4 border-b">
                            <h2 class="text-xl font-semibold text-gray-700">Session Information</h2>
                            <button id="generateNoteBtn" class="btn btn-primary font-semibold py-1 px-3 rounded-lg text-sm" disabled>Generate Note</button>
                        </div>
                        <div class="p-4 flex-grow">
                            <textarea id="sessionInfo" class="w-full h-full border border-gray-300 rounded-md p-3 focus:outline-none focus:ring-2 focus:ring-sky-400" placeholder="Enter session details here..." disabled style="resize: vertical;"></textarea>
                        </div>
                    </div>
                    <div class="resizer-y" id="resizer-session-notes"></div>
                    <div id="notesWrapper" class="flex flex-col" style="flex-basis: 50%;">
                         <h2 class="text-xl font-semibold text-gray-700 p-4 border-b border-t">Persistent Notes</h2>
                        <div class="p-4 flex-grow">
                            <textarea id="persistentNotes" class="w-full h-full border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-sky-400" placeholder="Notes to reference across multiple sessions..." disabled style="resize: vertical;"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div class="resizer" id="resizer3"></div>

            <!-- Panel 4: SOAP Note -->
            <div class="panel flex flex-col" id="panelSoap" style="flex-basis: 33.33%;">
                <h2 class="text-xl font-semibold text-gray-700 p-4 border-b">SOAP Note</h2>
                <div class="p-4 flex-grow overflow-y-auto space-y-4">
                    <!-- Subjective -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label for="soapS" class="font-semibold text-gray-600">S (Subjective)</label>
                            <button class="btn-copy btn btn-secondary text-xs px-2 py-1 rounded-md" data-target="soapS">Copy</button>
                        </div>
                        <textarea id="soapS" class="soap-input w-full h-28 border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-sky-400" placeholder="• " disabled></textarea>
                    </div>
                    <!-- Objective -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label for="soapO" class="font-semibold text-gray-600">O (Objective)</label>
                            <button class="btn-copy btn btn-secondary text-xs px-2 py-1 rounded-md" data-target="soapO">Copy</button>
                        </div>
                        <textarea id="soapO" class="soap-input w-full h-28 border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-sky-400" placeholder="• " disabled></textarea>
                    </div>
                    <!-- Assessment -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label for="soapA" class="font-semibold text-gray-600">A (Assessment)</label>
                            <button class="btn-copy btn btn-secondary text-xs px-2 py-1 rounded-md" data-target="soapA">Copy</button>
                        </div>
                        <textarea id="soapA" class="soap-input w-full h-28 border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-sky-400" placeholder="• " disabled></textarea>
                    </div>
                    <!-- Plan -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label for="soapP" class="font-semibold text-gray-600">P (Plan)</label>
                            <button class="btn-copy btn btn-secondary text-xs px-2 py-1 rounded-md" data-target="soapP">Copy</button>
                        </div>
                        <textarea id="soapP" class="soap-input w-full h-28 border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-sky-400" placeholder="• " disabled></textarea>
                    </div>
                </div>
            </div>
        </main>
                <!-- Message Box for copy confirmation -->
        <div id="messageBox" class="fixed bottom-5 right-5 bg-gray-800 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-300">
            Copied to clipboard!
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const clientListEl = document.getElementById('clientList');
            const newClientInput = document.getElementById('newClientInput');
            const addClientBtn = document.getElementById('addClientBtn');
            const appointmentListEl = document.getElementById('appointmentList');
            const addAppointmentBtn = document.getElementById('addAppointmentBtn');
            const appointmentDateEl = document.getElementById('appointmentDate');
            const deletedClientsListEl = document.getElementById('deletedClientsList');
            const clearDeletedClientsBtn = document.getElementById('clearDeletedClientsBtn');
            const archivedClientsListEl = document.getElementById('archivedClientsList');
            const deletedAppointmentsListEl = document.getElementById('deletedAppointmentsList');
            const clearDeletedAppointmentsBtn = document.getElementById('clearDeletedAppointmentsBtn');
            const persistentNotesEl = document.getElementById('persistentNotes');
            const sessionInfoEl = document.getElementById('sessionInfo');
            const soapSEl = document.getElementById('soapS');
            const soapOEl = document.getElementById('soapO');
            const soapAEl = document.getElementById('soapA');
            const soapPEl = document.getElementById('soapP');
            const saveBtn = document.getElementById('saveBtn');
            const loadBtn = document.getElementById('loadBtn');
            const eraseAllBtn = document.getElementById('eraseAllBtn');
            const autoSaveIndicator = document.getElementById('autoSaveIndicator');
            const saveStatus = document.getElementById('saveStatus');
            // AI Integration Elements
            const apiKeyInput = document.getElementById('apiKeyInput');
            const setApiKeyBtn = document.getElementById('setApiKeyBtn');
            const generateNoteBtn = document.getElementById('generateNoteBtn');

            // App State
            let data = { clients: [], archivedClients: [] };
            let deletedItems = { clients: [], appointments: [] };
            let selectedClientId = null;
            let selectedAppointmentId = null;
            let isDirty = false; // Flag to check if there are unsaved changes
            let geminiApiKey = null;
            const getInitialData = () => ({ clients: [], archivedClients: [] });

            // --- Data Management ---
            const findClient = id => data.clients.find(c => c.id === id) || data.archivedClients.find(c => c.id === id);
            const findAppointment = (client, id) => client?.appointments.find(a => a.id === id);

            // --- UI Rendering ---
            const renderClients = () => {
                clientListEl.innerHTML = '';
                if (data.clients.length === 0) {
                     clientListEl.innerHTML = '<p class="p-4 text-sm text-gray-500">No active clients.</p>';
                }
                data.clients.sort((a, b) => a.name.localeCompare(b.name));
                data.clients.forEach(client => {
                    const div = document.createElement('div');
                    div.className = `list-item flex justify-between items-center p-3 border-b ${client.id === selectedClientId ? 'selected' : ''}`;
                    div.dataset.id = client.id;
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = client.name;
                    nameSpan.className = 'truncate flex-grow cursor-pointer';
                    div.appendChild(nameSpan);

                    const btnGroup = document.createElement('div');
                    btnGroup.className = 'flex items-center space-x-2 ml-2';
                    const archiveBtn = document.createElement('button');
                    archiveBtn.textContent = 'Archive';
                    archiveBtn.title = 'Archive Client';
                    archiveBtn.className = 'btn btn-secondary text-xs px-2 py-1 rounded-md';
                    archiveBtn.onclick = (e) => {
                        e.stopPropagation();
                        archiveClient(client.id);
                    };
                    btnGroup.appendChild(archiveBtn);

                    const removeBtn = document.createElement('button');
                    removeBtn.innerHTML = '&times;';
                    removeBtn.title = 'Delete Client';
                    removeBtn.className = 'font-bold text-red-500 hover:text-red-700 text-xl px-1 rounded-full w-6 h-6 flex items-center justify-center';
                    removeBtn.onclick = (e) => {
                        e.stopPropagation();
                        if (confirm(`Are you sure you want to delete ${client.name}? You can restore this client later.`)) {
                            removeClient(client.id);
                        }
                    };
                    btnGroup.appendChild(removeBtn);
                    div.appendChild(btnGroup);
                    div.onclick = () => selectClient(client.id);
                    clientListEl.appendChild(div);
                });
            };

            const renderAppointments = () => {
                const client = findClient(selectedClientId);
                appointmentListEl.innerHTML = '';
                if (!client) {
                    appointmentListEl.innerHTML = '<p class="p-4 text-sm text-gray-500">Select a client to see appointments.</p>';
                    return;
                }
                if (!client.appointments || client.appointments.length === 0) {
                    appointmentListEl.innerHTML = '<p class="p-4 text-sm text-gray-500">No appointments yet.</p>';
                    return;
                }
                client.appointments.sort((a, b) => new Date(b.date) - new Date(a.date));
                client.appointments.forEach(appt => {
                    const div = document.createElement('div');
                    div.className = `list-item flex justify-between items-center p-3 border-b ${appt.id === selectedAppointmentId ? 'selected' : ''}`;
                    div.dataset.id = appt.id;

                    const span = document.createElement('span');
                    span.textContent = new Date(appt.date).toLocaleDateString();
                    span.className = 'flex-grow cursor-pointer';
                    div.appendChild(span);

                    const removeBtn = document.createElement('button');
                    removeBtn.innerHTML = '&times;';
                    removeBtn.title = 'Delete Appointment';
                    removeBtn.className = 'font-bold text-red-500 hover:text-red-700 text-xl px-1 rounded-full w-6 h-6 flex items-center justify-center';
                    removeBtn.onclick = (e) => {
                        e.stopPropagation();
                         if (confirm(`Are you sure you want to delete the appointment on ${new Date(appt.date).toLocaleDateString()}? You can restore it later.`)) {
                            removeAppointment(appt.id);
                        }
                    };
                    div.appendChild(removeBtn);
                    div.onclick = () => selectAppointment(appt.id);
                    appointmentListEl.appendChild(div);
                });
            };

            const renderDetails = () => {
                const client = findClient(selectedClientId);
                const appointment = findAppointment(client, selectedAppointmentId);

                // Enable/disable inputs
                persistentNotesEl.disabled = !client;
                sessionInfoEl.disabled = !appointment;
                [soapSEl, soapOEl, soapAEl, soapPEl].forEach(el => el.disabled = !appointment);
                addAppointmentBtn.disabled = !client;
                generateNoteBtn.disabled = !appointment || !geminiApiKey || !sessionInfoEl.value.trim();

                // Populate data
                persistentNotesEl.value = client ? (client.persistentNotes || '') : '';
                sessionInfoEl.value = appointment ? (appointment.sessionInfo || '') : '';
                soapSEl.value = appointment ? (appointment.soap?.s || '') : '';
                soapOEl.value = appointment ? (appointment.soap?.o || '') : '';
                soapAEl.value = appointment ? (appointment.soap?.a || '') : '';
                soapPEl.value = appointment ? (appointment.soap?.p || '') : '';
            };

            const renderDeletedLists = () => {
                deletedClientsListEl.innerHTML = '';
                if (deletedItems.clients.length === 0) {
                    deletedClientsListEl.innerHTML = '<p class="text-xs text-gray-400">None</p>';
                }
                deletedItems.clients.forEach(client => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center text-xs py-1';
                    div.innerHTML = `<span>${client.name}</span>`;
                    const btn = document.createElement('button');
                    btn.textContent = 'Restore';
                    btn.className = 'btn btn-secondary text-xs px-1 py-0.5 rounded';
                    btn.onclick = () => restoreClient(client.id);
                    div.appendChild(btn);
                    deletedClientsListEl.appendChild(div);
                });

                deletedAppointmentsListEl.innerHTML = '';
                if (deletedItems.appointments.length === 0) {
                    deletedAppointmentsListEl.innerHTML = '<p class="text-xs text-gray-400">None</p>';
                }
                deletedItems.appointments.forEach(appt => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center text-xs py-1';
                    const clientName = findClient(appt.clientId)?.name || 'Unknown';
                    div.innerHTML = `<span>${new Date(appt.date).toLocaleDateString()} (${clientName})</span>`;
                    const btn = document.createElement('button');
                    btn.textContent = 'Restore';
                    btn.className = 'btn btn-secondary text-xs px-1 py-0.5 rounded';
                    btn.onclick = () => restoreAppointment(appt.id);
                    div.appendChild(btn);
                    deletedAppointmentsListEl.appendChild(div);
                });
            };

            const renderArchivedClients = () => {
                archivedClientsListEl.innerHTML = '';
                if (!data.archivedClients || data.archivedClients.length === 0) {
                    archivedClientsListEl.innerHTML = '<p class="text-xs text-gray-400">None</p>';
                    return;
                }
                data.archivedClients.sort((a, b) => a.name.localeCompare(b.name));
                data.archivedClients.forEach(client => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center text-xs py-1';
                    div.innerHTML = `<span>${client.name}</span>`;
                    const btn = document.createElement('button');
                    btn.textContent = 'Unarchive';
                    btn.className = 'btn btn-secondary text-xs px-1 py-0.5 rounded';
                    btn.onclick = () => unarchiveClient(client.id);
                    div.appendChild(btn);
                    archivedClientsListEl.appendChild(div);
                });
            };

            const fullRender = () => {
                renderClients();
                renderAppointments();
                renderDetails();
                renderDeletedLists();
                renderArchivedClients();
            };

            // --- Event Handlers & Actions ---
            const selectClient = (id) => {
                selectedClientId = id;
                selectedAppointmentId = null; // Deselect appointment when changing client
                markDirty();
                fullRender();
            };

            const selectAppointment = (id) => {
                selectedAppointmentId = id;
                markDirty();
                fullRender();
            };

            const addClient = () => {
                const name = newClientInput.value.trim();
                if (!name) return;
                const newClient = {
                    id: crypto.randomUUID(),
                    name,
                    persistentNotes: '',
                    appointments: []
                };
                data.clients.push(newClient);
                newClientInput.value = '';
                selectClient(newClient.id);
                markDirty();
            };

            const removeClient = (id) => {
                const clientIndex = data.clients.findIndex(c => c.id === id);
                if (clientIndex === -1) return;
                const [client] = data.clients.splice(clientIndex, 1);
                if (client.appointments) {
                    client.appointments.forEach(appt => {
                        deletedItems.appointments.push({ ...appt, clientId: client.id });
                    });
                }
                deletedItems.clients.push(client);
                if (selectedClientId === id) {
                    selectedClientId = null;
                    selectedAppointmentId = null;
                }
                fullRender();
                markDirty();
            };

            const restoreClient = (id) => {
                const clientIndex = deletedItems.clients.findIndex(c => c.id === id);
                if (clientIndex === -1) return;
                const [client] = deletedItems.clients.splice(clientIndex, 1);
                const appointmentsToRestore = deletedItems.appointments.filter(a => a.clientId === id);
                client.appointments = client.appointments || [];
                client.appointments.push(...appointmentsToRestore);
                deletedItems.appointments = deletedItems.appointments.filter(a => a.clientId !== id);
                data.clients.push(client);
                fullRender();
                markDirty();
            };

            const archiveClient = (id) => {
                const clientIndex = data.clients.findIndex(c => c.id === id);
                if (clientIndex === -1) return;
                const [client] = data.clients.splice(clientIndex, 1);
                if (!data.archivedClients) data.archivedClients = [];
                data.archivedClients.push(client);
                if (selectedClientId === id) {
                    selectedClientId = null;
                    selectedAppointmentId = null;
                }
                fullRender();
                markDirty();
            };

            const unarchiveClient = (id) => {
                if (!data.archivedClients) return;
                const clientIndex = data.archivedClients.findIndex(c => c.id === id);
                if (clientIndex === -1) return;
                const [client] = data.archivedClients.splice(clientIndex, 1);
                data.clients.push(client);
                fullRender();
                markDirty();
            };

            const addAppointment = () => {
                const client = findClient(selectedClientId);
                if (!client || !appointmentDateEl.value) {
                    alert('Please select a client and a date to add an appointment.');
                    return;
                }
                const newAppointment = {
                    id: crypto.randomUUID(),
                    date: new Date(appointmentDateEl.value).toISOString(),
                    sessionInfo: '',
                    soap: { s: '• ', o: '• ', a: '• ', p: '• ' }
                };
                if (!client.appointments) client.appointments = [];
                client.appointments.push(newAppointment);
                selectAppointment(newAppointment.id);
                markDirty();
            };

            const removeAppointment = (id) => {
                const client = findClient(selectedClientId);
                if (!client || !client.appointments) return;
                const apptIndex = client.appointments.findIndex(a => a.id === id);
                if (apptIndex === -1) return;
                const [appt] = client.appointments.splice(apptIndex, 1);
                deletedItems.appointments.push({ ...appt, clientId: client.id });
                 if (selectedAppointmentId === id) {
                    selectedAppointmentId = null;
                }
                fullRender();
                markDirty();
            };

            const restoreAppointment = (id) => {
                const apptIndex = deletedItems.appointments.findIndex(a => a.id === id);
                if (apptIndex === -1) return;
                const [appt] = deletedItems.appointments.splice(apptIndex, 1);
                const client = findClient(appt.clientId);
                if (client) {
                    if (!client.appointments) client.appointments = [];
                    client.appointments.push(appt);
                    fullRender();
                    markDirty();
                } else {
                    deletedItems.appointments.push(appt);
                    alert('Cannot restore appointment because its client could not be found. Restore the client first.');
                }
            };

            const handleSoapKeydown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const target = e.target;
                    const start = target.selectionStart;
                    const end = target.selectionEnd;
                    const text = target.value;
                    target.value = text.substring(0, start) + '\n• ' + text.substring(end);
                    target.selectionStart = target.selectionEnd = start + 3;
                    markDirty();
                }
            };
            [soapSEl, soapOEl, soapAEl, soapPEl].forEach(el => {
                el.addEventListener('keydown', handleSoapKeydown);
            });

            // --- AI SOAP Note Generation ---
            const generateSoapNote = async () => {
                if (!geminiApiKey) {
                    alert('Please set your Gemini API key first.');
                    return;
                }

                const client = findClient(selectedClientId);
                const appointment = findAppointment(client, selectedAppointmentId);
                if (!client || !appointment || !sessionInfoEl.value.trim()) {
                    alert('Please select a client and appointment, and enter some session information.');
                    return;
                }

                generateNoteBtn.disabled = true;
                generateNoteBtn.textContent = 'Generating...';

                const systemPrompt = `You are a helpful assistant for a therapist or clinician. Your task is to convert raw session notes into a structured SOAP note format. The user will provide "Persistent Notes" which contain background information about the client, and "Session Information" which contains the notes from the current session. Analyze both sets of notes and generate a SOAP note.

**Guidelines for each section:**
- **Subjective (S):** What the client reports. Direct quotes, feelings, goals, and history reported by the client.
- **Objective (O):** Observable facts. The clinician's observations of the client's affect, appearance, behavior, and body language.
- **Assessment (A):** The clinician's professional judgment and interpretation of the subjective and objective information. Diagnosis, progress towards goals, and clinical impressions.
- **Plan (P):** The course of action. Topics for the next session, homework, referrals, and treatment plan modifications.

Each key's value in the final JSON object should be a string formatted with bullet points (•) for each distinct point.
`;

                 const userPrompt = `
- **Client Name:** ${client.name}
- **Persistent Notes (Background):**
${persistentNotesEl.value || 'N/A'}

- **Session Information (This Session):**
${sessionInfoEl.value}
`;

                const payload = {
                    contents: [{ parts: [{ text: userPrompt }] }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "s": { "type": "STRING", "description": "Subjective notes, client's reports." },
                                "o": { "type": "STRING", "description": "Objective notes, clinician's observations." },
                                "a": { "type": "STRING", "description": "Assessment of the session." },
                                "p": { "type": "STRING", "description": "Plan for future sessions." }
                            },
                            required: ["s", "o", "a", "p"]
                        }
                    }
                };
                
                try {
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${geminiApiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || 'An unknown API error occurred.');
                    }

                    const result = await response.json();
                    const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!generatedText) {
                        throw new Error("Received an empty response from the AI.");
                    }

                    const soapData = JSON.parse(generatedText);

                    if (typeof soapData.s !== 'string' || typeof soapData.o !== 'string' || typeof soapData.a !== 'string' || typeof soapData.p !== 'string') {
                        throw new Error('AI response was not in the expected format.');
                    }

                    // Update UI and data model
                    soapSEl.value = soapData.s;
                    soapOEl.value = soapData.o;
                    soapAEl.value = soapData.a;
                    soapPEl.value = soapData.p;

                    if (!appointment.soap) appointment.soap = {};
                    appointment.soap.s = soapData.s;
                    appointment.soap.o = soapData.o;
                    appointment.soap.a = soapData.a;
                    appointment.soap.p = soapData.p;
                    markDirty();

                } catch (error) {
                    console.error('SOAP Note Generation Error:', error);
                    alert(`Failed to generate SOAP note. Please check your API key and the console for more details.\nError: ${error.message}`);
                } finally {
                    generateNoteBtn.disabled = false;
                    generateNoteBtn.textContent = 'Generate Note';
                    renderDetails(); // Re-run to ensure button state is correct
                }
            };

            // --- Data Persistence (Save/Load/AutoSave) ---
            const updateSaveStatus = (message, isGood = true, duration = 0) => {
                autoSaveIndicator.classList.remove('hidden');
                saveStatus.textContent = message;
                saveStatus.style.color = isGood ? 'green' : 'red';
                if (duration > 0) {
                    setTimeout(() => {
                         if (saveStatus.textContent === message) {
                            autoSaveIndicator.classList.add('hidden');
                         }
                    }, duration);
                }
            }

            const markDirty = () => {
                if (!isDirty) {
                    isDirty = true;
                    updateSaveStatus('Unsaved changes...', false);
                }
                debouncedAutoSave();
            };

            const saveDataToCookie = () => {
                try {
                    const state = { data, deletedItems, selectedClientId, selectedAppointmentId };
                    document.cookie = `clientData=${encodeURIComponent(JSON.stringify(state))};path=/;max-age=31536000;samesite=strict`;
                    isDirty = false;
                } catch (e) {
                    console.error("Failed to save to cookie", e);
                    updateSaveStatus('Cookie save failed!', false, 3000);
                }
            };

            const loadDataFromCookie = () => {
                const cookie = document.cookie.split('; ').find(row => row.startsWith('clientData='));
                if (cookie) {
                    try {
                        const state = JSON.parse(decodeURIComponent(cookie.split('=')[1]));
                        data = state.data || getInitialData();
                        if (!data.archivedClients) data.archivedClients = [];
                        deletedItems = state.deletedItems || { clients: [], appointments: [] };
                        selectedClientId = state.selectedClientId || null;
                        selectedAppointmentId = state.selectedAppointmentId || null;
                        updateSaveStatus('Loaded from cookie', true, 2000);
                    } catch (e) {
                        console.error("Failed to load from cookie", e);
                        data = getInitialData();
                        deletedItems = { clients: [], appointments: [] };
                    }
                }
            };

            const saveFile = async (isAutoSave = false) => {
                if (isAutoSave) {
                    if (!isDirty) return;
                    updateSaveStatus('Saving...', true);
                    saveDataToCookie();
                    setTimeout(() => {
                        if (!isDirty) {
                           updateSaveStatus('Auto-saved', true, 2000);
                        }
                    }, 500);
                    return;
                }
                try {
                    saveDataToCookie();
                    const cookie = document.cookie.split('; ').find(row => row.startsWith('clientData='));
                    if (!cookie) {
                        updateSaveStatus('Nothing to export!', false, 3000);
                        return;
                    }
                    const stateJSON = decodeURIComponent(cookie.split('=')[1]);
                    const blob = new Blob([stateJSON], { type: 'application/json' });
                    const handle = await window.showSaveFilePicker({
                        suggestedName: `client-data-${new Date().toISOString().split('T')[0]}.json`,
                        types: [{ description: 'JSON Files', accept: { 'application/json': ['.json'] } }]
                    });
                    const writable = await handle.createWritable();
                    await writable.write(blob);
                    await writable.close();
                    updateSaveStatus('Exported successfully!', true, 3000);
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.error('Failed to export file:', err);
                        updateSaveStatus('Export failed!', false, 3000);
                    }
                }
            };

            const loadFile = async () => {
                 if (isDirty && !confirm('You have unsaved changes that will be lost. Are you sure you want to import a new file?')) {
                    return;
                }
                try {
                    const [handle] = await window.showOpenFilePicker({
                        types: [{ description: 'JSON Files', accept: { 'application/json': ['.json'] } }]
                    });
                    const file = await handle.getFile();
                    const contents = await file.text();
                    JSON.parse(contents); // Validate JSON
                    document.cookie = `clientData=${encodeURIComponent(contents)};path=/;max-age=31536000;samesite=strict`;
                    updateSaveStatus(`Imported ${file.name}. Reloading...`, true, 3000);
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.error('Failed to load file:', err);
                        updateSaveStatus('Import failed! Invalid file.', false, 3000);
                    }
                }
            };

            const eraseAllData = () => {
                const confirmationText = "DELETE ALL DATA";
                const userInput = prompt(`This action will permanently erase all client data from this browser. This cannot be undone.\n\nTo confirm, please type "${confirmationText}" in the box below.`);
                if (userInput === confirmationText) {
                    data = getInitialData();
                    deletedItems = { clients: [], appointments: [] };
                    selectedClientId = null;
                    selectedAppointmentId = null;
                    isDirty = false;
                    document.cookie = 'clientData=;path=/;max-age=0';
                    localStorage.removeItem('columnSizes');
                    localStorage.removeItem('rowSizes');
                    localStorage.removeItem('geminiApiKey');
                    autoSaveIndicator.classList.add('hidden');
                    alert('All data has been permanently erased. The page will now reload.');
                    window.location.reload();
                } else if (userInput !== null) {
                    alert('The text you entered did not match. No data has been erased.');
                }
            };

            let saveTimeout;
            const debouncedAutoSave = () => {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    saveFile(true);
                }, 1500);
            };

            // --- Event Listeners ---
            addClientBtn.addEventListener('click', addClient);
            newClientInput.addEventListener('keyup', (e) => e.key === 'Enter' && addClient());
            addAppointmentBtn.addEventListener('click', addAppointment);
            saveBtn.addEventListener('click', () => saveFile(false));
            loadBtn.addEventListener('click', loadFile);
            eraseAllBtn.addEventListener('click', eraseAllData);
            generateNoteBtn.addEventListener('click', generateSoapNote);

            setApiKeyBtn.addEventListener('click', () => {
                const key = apiKeyInput.value.trim();
                if (key) {
                    localStorage.setItem('geminiApiKey', key);
                    geminiApiKey = key;
                    updateSaveStatus('API Key saved.', true, 2000);
                } else {
                    localStorage.removeItem('geminiApiKey');
                    geminiApiKey = null;
                    updateSaveStatus('API Key removed.', true, 2000);
                }
                fullRender();
            });

            clearDeletedClientsBtn.addEventListener('click', () => {
                if (deletedItems.clients.length > 0 && confirm('Are you sure you want to permanently delete all recently deleted clients? This cannot be undone.')) {
                    deletedItems.clients = [];
                    fullRender();
                    markDirty();
                }
            });
            clearDeletedAppointmentsBtn.addEventListener('click', () => {
                if (deletedItems.appointments.length > 0 && confirm('Are you sure you want to permanently delete all recently deleted appointments? This cannot be undone.')) {
                    deletedItems.appointments = [];
                    fullRender();
                    markDirty();
                }
            });

            persistentNotesEl.addEventListener('input', () => {
                const client = findClient(selectedClientId);
                if (client) {
                    client.persistentNotes = persistentNotesEl.value;
                    markDirty();
                }
            });
            sessionInfoEl.addEventListener('input', () => {
                const client = findClient(selectedClientId);
                const appointment = findAppointment(client, selectedAppointmentId);
                if (appointment) {
                    appointment.sessionInfo = sessionInfoEl.value;
                    markDirty();
                }
                renderDetails(); // Update generate button state
            });
            [soapSEl, soapOEl, soapAEl, soapPEl].forEach(el => {
                el.addEventListener('input', () => {
                    const client = findClient(selectedClientId);
                    const appointment = findAppointment(client, selectedAppointmentId);
                    if (appointment) {
                        const key = el.id.slice(-1).toLowerCase();
                        if (!appointment.soap) appointment.soap = {};
                        appointment.soap[key] = el.value;
                        markDirty();
                    }
                });
            });

            document.querySelectorAll('.btn-copy').forEach(button => {
                button.addEventListener('click', () => {
                    const targetId = button.dataset.target;
                    const textarea = document.getElementById(targetId);
                    if (textarea.disabled) return;
                    navigator.clipboard.writeText(textarea.value).then(() => {
                        const messageBox = document.getElementById('messageBox');
                        messageBox.classList.remove('opacity-0');
                        setTimeout(() => {
                            messageBox.classList.add('opacity-0');
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy text: ', err);
                    });
                });
            });

            // --- Resizable Panels ---
            const panels = ['panelClients', 'panelAppointments', 'panelSession', 'panelSoap'];
            function saveColumnSizes() {
                const sizes = panels.map(id => document.getElementById(id).style.flexBasis);
                localStorage.setItem('columnSizes', JSON.stringify(sizes));
                const sessionInfoHeight = document.getElementById('sessionInfoWrapper').style.flexBasis;
                const notesHeight = document.getElementById('notesWrapper').style.flexBasis;
                localStorage.setItem('rowSizes', JSON.stringify({ sessionInfoHeight, notesHeight }));
            }

            function loadColumnSizes() {
                const sizes = JSON.parse(localStorage.getItem('columnSizes'));
                if (sizes && sizes.length === panels.length) {
                    panels.forEach((id, index) => {
                        const panel = document.getElementById(id);
                        if (panel) panel.style.flexBasis = sizes[index];
                    });
                }
                const rowSizes = JSON.parse(localStorage.getItem('rowSizes'));
                if (rowSizes) {
                    const sessionWrapper = document.getElementById('sessionInfoWrapper');
                    const notesWrapper = document.getElementById('notesWrapper');
                    if (sessionWrapper) sessionWrapper.style.flexBasis = rowSizes.sessionInfoHeight;
                    if (notesWrapper) notesWrapper.style.flexBasis = rowSizes.notesHeight;
                }
            }

            function makeResizable(resizer, prev, next, direction = 'x') {
                if (!resizer || !prev || !next) return;
                let isResizing = false;
                resizer.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    isResizing = true;
                    const cursor = direction === 'x' ? 'col-resize' : 'row-resize';
                    document.body.style.cursor = cursor;
                    document.body.style.userSelect = 'none';

                    const mousemove = (e) => {
                        if (!isResizing) return;
                        const prevRect = prev.getBoundingClientRect();
                        const nextRect = next.getBoundingClientRect();
                        if (direction === 'x') {
                            const newPrevWidth = e.clientX - prevRect.left;
                            const newNextWidth = nextRect.right - e.clientX;
                            if (newPrevWidth > 150 && newNextWidth > 150) {
                                prev.style.flexBasis = `${newPrevWidth}px`;
                                next.style.flexBasis = `${newNextWidth}px`;
                            }
                        } else {
                            const newPrevHeight = e.clientY - prevRect.top;
                            const newNextHeight = nextRect.bottom - e.clientY;
                            if (newPrevHeight > 100 && newNextHeight > 100) {
                                prev.style.flexBasis = `${newPrevHeight}px`;
                                next.style.flexBasis = `${newNextHeight}px`;
                            }
                        }
                    };

                    const mouseup = () => {
                        isResizing = false;
                        window.removeEventListener('mousemove', mousemove);
                        window.removeEventListener('mouseup', mouseup);
                        document.body.style.cursor = '';
                        document.body.style.userSelect = '';
                        saveColumnSizes();
                    };
                    window.addEventListener('mousemove', mousemove);
                    window.addEventListener('mouseup', mouseup);
                });
            }
            makeResizable(document.getElementById('resizer1'), document.getElementById('panelClients'), document.getElementById('panelAppointments'), 'x');
            makeResizable(document.getElementById('resizer2'), document.getElementById('panelAppointments'), document.getElementById('panelSession'), 'x');
            makeResizable(document.getElementById('resizer3'), document.getElementById('panelSession'), document.getElementById('panelSoap'), 'x');
            makeResizable(document.getElementById('resizer-session-notes'), document.getElementById('sessionInfoWrapper'), document.getElementById('notesWrapper'), 'y');

            // --- Initial Load & Render ---
            const loadApiKey = () => {
                const key = localStorage.getItem('geminiApiKey');
                if (key) {
                    geminiApiKey = key;
                    apiKeyInput.value = key; // Don't show the key, but keep it in state
                }
            };

            loadApiKey();
            loadDataFromCookie();
            loadColumnSizes();
            appointmentDateEl.value = new Date().toISOString().split('T')[0];
            fullRender();
        });
    </script>
</body>
</html>
