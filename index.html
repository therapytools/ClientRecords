<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Data Organizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #c7c7c7;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        .panel {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            display: flex;
            flex-direction: column;
            height: calc(100vh - 8rem);
        }
        .list-item {
            cursor: pointer;
            transition: background-color 0.2s;
            border-right: 4px solid transparent;
        }
        .list-item.selected {
            background-color: #e0f2fe;
            border-color: #38bdf8;
            font-weight: 600;
        }
        .list-item:hover {
            background-color: #f0f9ff;
        }
        textarea {
            resize: none;
        }
        .btn {
            transition: background-color 0.2s, transform 0.1s;
        }
        .btn:hover {
            transform: translateY(-1px);
        }
        .btn-primary {
            background-color: #38bdf8;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0ea5e9;
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #374151;
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        .btn-danger {
             background-color: #fee2e2;
             color: #ef4444;
        }
        .btn-danger:hover {
            background-color: #fecaca;
            color: #dc2626;
        }
    </style>
</head>
<body class="p-4 md:p-6 lg:p-8">

    <div id="app" class="flex flex-col h-full">
        <!-- Header -->
        <header class="flex flex-wrap items-center justify-between mb-6 pb-4 border-b">
            <h1 class="text-3xl font-bold text-gray-800">Client Data Organizer</h1>
            <div class="flex items-center space-x-2 mt-4 sm:mt-0">
                <button id="newBtn" class="btn btn-secondary font-semibold py-2 px-4 rounded-lg shadow-sm">New</button>
                <button id="saveBtn" class="btn btn-primary font-semibold py-2 px-4 rounded-lg shadow-sm">Save</button>
                <button id="loadBtn" class="btn btn-secondary font-semibold py-2 px-4 rounded-lg shadow-sm">Load</button>
                <div id="autoSaveIndicator" class="text-sm text-gray-500 ml-4 hidden">
                    <span id="saveStatus"></span>
                </div>
            </div>
        </header>

        <!-- Main Content Grid -->
        <main class="grid grid-cols-12 gap-6 flex-grow">
            <!-- Panel 1: Clients -->
            <div class="col-span-12 md:col-span-2 panel">
                <h2 class="text-xl font-semibold text-gray-700 p-4 border-b">Clients</h2>
                <div id="clientList" class="flex-grow overflow-y-auto"></div>
                <div class="p-4 border-t">
                    <input type="text" id="newClientInput" class="w-full border border-gray-300 rounded-md px-3 py-2 mb-2 focus:outline-none focus:ring-2 focus:ring-sky-400" placeholder="New client name...">
                    <button id="addClientBtn" class="w-full btn btn-primary font-semibold py-2 rounded-lg">Add Client</button>
                </div>
            </div>

            <!-- Panel 2: Appointments & Persistent Notes -->
            <div class="col-span-12 md:col-span-2 panel">
                <h2 class="text-xl font-semibold text-gray-700 p-4 border-b">Appointments</h2>
                <div id="appointmentList" class="flex-grow overflow-y-auto"></div>
                <div class="p-4 border-t">
                    <button id="addAppointmentBtn" class="w-full btn btn-primary font-semibold py-2 rounded-lg mb-4" disabled>Add Appointment</button>
                    <h3 class="font-semibold text-gray-600 mb-2">Persistent Notes</h3>
                    <textarea id="persistentNotes" class="w-full h-32 border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-sky-400" placeholder="Notes to reference across multiple sessions..." disabled></textarea>
                </div>
            </div>

            <!-- Panel 3: Session Information -->
            <div class="col-span-12 md:col-span-4 panel">
                <h2 class="text-xl font-semibold text-gray-700 p-4 border-b">Session Information</h2>
                <div class="p-4 flex-grow">
                    <textarea id="sessionInfo" class="w-full h-full border border-gray-300 rounded-md p-3 focus:outline-none focus:ring-2 focus:ring-sky-400" placeholder="Enter session details here..." disabled></textarea>
                </div>
            </div>

            <!-- Panel 4: SOAP Note -->
            <div class="col-span-12 md:col-span-4 panel">
                <h2 class="text-xl font-semibold text-gray-700 p-4 border-b">SOAP Note</h2>
                <div class="p-4 flex-grow overflow-y-auto space-y-4">
                    <!-- Subjective -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label for="soapS" class="font-semibold text-gray-600">S (Subjective)</label>
                            <button class="btn-copy btn btn-secondary text-xs px-2 py-1 rounded-md" data-target="soapS">Copy</button>
                        </div>
                        <textarea id="soapS" class="soap-input w-full h-28 border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-sky-400" placeholder="• " disabled></textarea>
                    </div>
                    <!-- Objective -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label for="soapO" class="font-semibold text-gray-600">O (Objective)</label>
                            <button class="btn-copy btn btn-secondary text-xs px-2 py-1 rounded-md" data-target="soapO">Copy</button>
                        </div>
                        <textarea id="soapO" class="soap-input w-full h-28 border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-sky-400" placeholder="• " disabled></textarea>
                    </div>
                    <!-- Assessment -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label for="soapA" class="font-semibold text-gray-600">A (Assessment)</label>
                            <button class="btn-copy btn btn-secondary text-xs px-2 py-1 rounded-md" data-target="soapA">Copy</button>
                        </div>
                        <textarea id="soapA" class="soap-input w-full h-28 border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-sky-400" placeholder="• " disabled></textarea>
                    </div>
                    <!-- Plan -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label for="soapP" class="font-semibold text-gray-600">P (Plan)</label>
                            <button class="btn-copy btn btn-secondary text-xs px-2 py-1 rounded-md" data-target="soapP">Copy</button>
                        </div>
                        <textarea id="soapP" class="soap-input w-full h-28 border border-gray-300 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-sky-400" placeholder="• " disabled></textarea>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Message Box for copy confirmation -->
        <div id="messageBox" class="fixed bottom-5 right-5 bg-gray-800 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-300">
            Copied to clipboard!
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const clientListEl = document.getElementById('clientList');
            const newClientInput = document.getElementById('newClientInput');
            const addClientBtn = document.getElementById('addClientBtn');
            const appointmentListEl = document.getElementById('appointmentList');
            const addAppointmentBtn = document.getElementById('addAppointmentBtn');
            const persistentNotesEl = document.getElementById('persistentNotes');
            const sessionInfoEl = document.getElementById('sessionInfo');
            const soapSEl = document.getElementById('soapS');
            const soapOEl = document.getElementById('soapO');
            const soapAEl = document.getElementById('soapA');
            const soapPEl = document.getElementById('soapP');
            const saveBtn = document.getElementById('saveBtn');
            const loadBtn = document.getElementById('loadBtn');
            const newBtn = document.getElementById('newBtn');
            const autoSaveIndicator = document.getElementById('autoSaveIndicator');
            const saveStatus = document.getElementById('saveStatus');

            // App State
            let data = { clients: [] };
            let selectedClientId = null;
            let selectedAppointmentId = null;
            let fileHandle = null;
            let isDirty = false; // Flag to check if there are unsaved changes

            const getInitialData = () => ({ clients: [] });

            // --- Data Management ---
            const findClient = id => data.clients.find(c => c.id === id);
            const findAppointment = (client, id) => client?.appointments.find(a => a.id === id);

            // --- UI Rendering ---
            const renderClients = () => {
                clientListEl.innerHTML = '';
                if (data.clients.length === 0) {
                     clientListEl.innerHTML = '<p class="p-4 text-sm text-gray-500">No clients yet. Add one below.</p>';
                }
                data.clients.forEach(client => {
                    const div = document.createElement('div');
                    div.className = `list-item flex justify-between items-center p-3 border-b ${client.id === selectedClientId ? 'selected' : ''}`;
                    div.dataset.id = client.id;
                    
                    const span = document.createElement('span');
                    span.textContent = client.name;
                    span.className = 'truncate';
                    div.appendChild(span);

                    const removeBtn = document.createElement('button');
                    removeBtn.innerHTML = '&times;';
                    removeBtn.className = 'font-bold text-red-500 hover:text-red-700 text-xl px-2';
                    removeBtn.onclick = (e) => {
                        e.stopPropagation();
                        if (confirm(`Are you sure you want to delete ${client.name} and all their data?`)) {
                            removeClient(client.id);
                        }
                    };
                    div.appendChild(removeBtn);
                    
                    div.onclick = () => selectClient(client.id);
                    clientListEl.appendChild(div);
                });
            };

            const renderAppointments = () => {
                const client = findClient(selectedClientId);
                appointmentListEl.innerHTML = '';
                if (!client) {
                    appointmentListEl.innerHTML = '<p class="p-4 text-sm text-gray-500">Select a client to see appointments.</p>';
                    return;
                }
                if (client.appointments.length === 0) {
                    appointmentListEl.innerHTML = '<p class="p-4 text-sm text-gray-500">No appointments yet.</p>';
                }

                client.appointments.sort((a, b) => new Date(b.date) - new Date(a.date));

                client.appointments.forEach(appt => {
                    const div = document.createElement('div');
                    div.className = `list-item flex justify-between items-center p-3 border-b ${appt.id === selectedAppointmentId ? 'selected' : ''}`;
                    div.dataset.id = appt.id;

                    const span = document.createElement('span');
                    span.textContent = new Date(appt.date).toLocaleDateString();
                    div.appendChild(span);

                    const removeBtn = document.createElement('button');
                    removeBtn.innerHTML = '&times;';
                    removeBtn.className = 'font-bold text-red-500 hover:text-red-700 text-xl px-2';
                    removeBtn.onclick = (e) => {
                        e.stopPropagation();
                         if (confirm(`Are you sure you want to delete the appointment on ${new Date(appt.date).toLocaleDateString()}?`)) {
                            removeAppointment(appt.id);
                        }
                    };
                    div.appendChild(removeBtn);

                    div.onclick = () => selectAppointment(appt.id);
                    appointmentListEl.appendChild(div);
                });
            };

            const renderDetails = () => {
                const client = findClient(selectedClientId);
                const appointment = findAppointment(client, selectedAppointmentId);

                // Enable/disable inputs
                persistentNotesEl.disabled = !client;
                sessionInfoEl.disabled = !appointment;
                [soapSEl, soapOEl, soapAEl, soapPEl].forEach(el => el.disabled = !appointment);
                addAppointmentBtn.disabled = !client;

                // Populate data
                persistentNotesEl.value = client ? client.persistentNotes : '';
                sessionInfoEl.value = appointment ? appointment.sessionInfo : '';
                soapSEl.value = appointment ? appointment.soap.s : '';
                soapOEl.value = appointment ? appointment.soap.o : '';
                soapAEl.value = appointment ? appointment.soap.a : '';
                soapPEl.value = appointment ? appointment.soap.p : '';
            };

            const fullRender = () => {
                renderClients();
                renderAppointments();
                renderDetails();
            };

            // --- Event Handlers & Actions ---
            const selectClient = (id) => {
                selectedClientId = id;
                selectedAppointmentId = null; // Deselect appointment when changing client
                fullRender();
            };

            const selectAppointment = (id) => {
                selectedAppointmentId = id;
                fullRender();
            };
            
            const addClient = () => {
                const name = newClientInput.value.trim();
                if (!name) return;
                const newClient = {
                    id: crypto.randomUUID(),
                    name,
                    persistentNotes: '',
                    appointments: []
                };
                data.clients.push(newClient);
                newClientInput.value = '';
                selectClient(newClient.id);
                markDirty();
            };
            
            const removeClient = (id) => {
                data.clients = data.clients.filter(c => c.id !== id);
                if (selectedClientId === id) {
                    selectedClientId = null;
                    selectedAppointmentId = null;
                }
                fullRender();
                markDirty();
            };

            const addAppointment = () => {
                const client = findClient(selectedClientId);
                if (!client) return;

                const newAppointment = {
                    id: crypto.randomUUID(),
                    date: new Date().toISOString(),
                    sessionInfo: '',
                    soap: { s: '• ', o: '• ', a: '• ', p: '• ' }
                };
                client.appointments.push(newAppointment);
                selectAppointment(newAppointment.id);
                markDirty();
            };
            
            const removeAppointment = (id) => {
                const client = findClient(selectedClientId);
                if (!client) return;
                client.appointments = client.appointments.filter(a => a.id !== id);
                 if (selectedAppointmentId === id) {
                    selectedAppointmentId = null;
                }
                fullRender();
                markDirty();
            };
            
            // Auto-bulleting for SOAP notes
            const handleSoapKeydown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const target = e.target;
                    const start = target.selectionStart;
                    const end = target.selectionEnd;
                    const text = target.value;
                    target.value = text.substring(0, start) + '\n• ' + text.substring(end);
                    target.selectionStart = target.selectionEnd = start + 3;
                }
            };

            [soapSEl, soapOEl, soapAEl, soapPEl].forEach(el => {
                el.addEventListener('keydown', handleSoapKeydown);
            });

            // --- Data Persistence (Save/Load/AutoSave) ---

            const updateSaveStatus = (message, isGood = true) => {
                autoSaveIndicator.classList.remove('hidden');
                saveStatus.textContent = message;
                saveStatus.style.color = isGood ? 'green' : 'red';
            }

            const markDirty = () => {
                isDirty = true;
                updateSaveStatus('Unsaved changes...', false);
                debouncedAutoSave();
            };
            
            const saveFile = async (isAutoSave = false) => {
                if (!isDirty && isAutoSave) return; // Don't auto-save if nothing changed
                 if (!fileHandle && !isAutoSave) {
                    try {
                        fileHandle = await window.showSaveFilePicker({
                            types: [{
                                description: 'JSON Files',
                                accept: { 'application/json': ['.json'] }
                            }]
                        });
                        localStorage.setItem('fileHandle', fileHandle); // This won't work directly, just conceptually storing
                    } catch (err) {
                        console.error('Save cancelled by user.', err);
                        return;
                    }
                }

                if (!fileHandle) {
                    if (!isAutoSave) alert('Could not save. Please use the "Save" button first to select a file location.');
                    return;
                }

                try {
                    updateSaveStatus('Saving...');
                    const writable = await fileHandle.createWritable();
                    await writable.write(JSON.stringify(data, null, 2));
                    await writable.close();
                    isDirty = false;
                    setTimeout(() => updateSaveStatus(`Saved at ${new Date().toLocaleTimeString()}`), 500);
                } catch (err) {
                    console.error('Failed to save file:', err);
                    updateSaveStatus('Save failed!', false);
                }
            };
            
            const loadFile = async () => {
                 if (isDirty && !confirm('You have unsaved changes. Are you sure you want to load a new file?')) {
                    return;
                }
                try {
                    const [handle] = await window.showOpenFilePicker({
                        types: [{
                            description: 'JSON Files',
                            accept: { 'application/json': ['.json'] }
                        }]
                    });
                    const file = await handle.getFile();
                    const contents = await file.text();
                    data = JSON.parse(contents);
                    fileHandle = handle;
                    selectedClientId = null;
                    selectedAppointmentId = null;
                    isDirty = false;
                    updateSaveStatus(`Loaded ${file.name}`);
                    fullRender();
                } catch (err) {
                    console.error('Failed to load file:', err);
                }
            };

            const newFile = () => {
                if (isDirty && !confirm('You have unsaved changes. Are you sure you want to create a new file?')) {
                    return;
                }
                data = getInitialData();
                selectedClientId = null;
                selectedAppointmentId = null;
                fileHandle = null;
                isDirty = false;
                autoSaveIndicator.classList.add('hidden');
                fullRender();
            };

            // Debounce function to prevent saving on every keystroke
            let saveTimeout;
            const debouncedAutoSave = () => {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    saveFile(true);
                }, 1500); // Wait 1.5 seconds after last edit
            };

            // --- Event Listeners ---
            addClientBtn.addEventListener('click', addClient);
            newClientInput.addEventListener('keyup', (e) => e.key === 'Enter' && addClient());
            addAppointmentBtn.addEventListener('click', addAppointment);
            saveBtn.addEventListener('click', () => saveFile(false));
            loadBtn.addEventListener('click', loadFile);
            newBtn.addEventListener('click', newFile);

            // Update data model on input change
            persistentNotesEl.addEventListener('input', () => {
                const client = findClient(selectedClientId);
                if (client) {
                    client.persistentNotes = persistentNotesEl.value;
                    markDirty();
                }
            });
            sessionInfoEl.addEventListener('input', () => {
                const client = findClient(selectedClientId);
                const appointment = findAppointment(client, selectedAppointmentId);
                if (appointment) {
                    appointment.sessionInfo = sessionInfoEl.value;
                    markDirty();
                }
            });
            [soapSEl, soapOEl, soapAEl, soapPEl].forEach(el => {
                el.addEventListener('input', () => {
                    const client = findClient(selectedClientId);
                    const appointment = findAppointment(client, selectedAppointmentId);
                    if (appointment) {
                        const key = el.id.slice(-1).toLowerCase();
                        appointment.soap[key] = el.value;
                        markDirty();
                    }
                });
            });

            // Copy to clipboard
            document.querySelectorAll('.btn-copy').forEach(button => {
                button.addEventListener('click', () => {
                    const targetId = button.dataset.target;
                    const textarea = document.getElementById(targetId);
                    
                    // Create a temporary textarea to copy from
                    const tempTextarea = document.createElement('textarea');
                    tempTextarea.value = textarea.value;
                    document.body.appendChild(tempTextarea);
                    tempTextarea.select();
                    try {
                        document.execCommand('copy');
                        const messageBox = document.getElementById('messageBox');
                        messageBox.classList.remove('opacity-0');
                        setTimeout(() => {
                            messageBox.classList.add('opacity-0');
                        }, 2000);
                    } catch (err) {
                        console.error('Failed to copy text: ', err);
                    }
                    document.body.removeChild(tempTextarea);
                });
            });


            // Initial Render
            fullRender();
        });
    </script>
</body>
</html>
